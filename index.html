<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Muziekspel</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,500;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080810; --sur: #111118; --s2: #18181f; --s3: #222230;
            --p1: #ff2d55; --p2: #00c8f8; --gold: #ffc940; --gray: #333340;
            --txt: #f0f0f0; --mut: #666; --r: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { background: var(--bg); color: var(--txt); font-family: 'DM Sans', sans-serif; }

        .screen { display: none; flex-direction: column; height: 100dvh; padding: env(safe-area-inset-top, 12px) 20px env(safe-area-inset-bottom, 20px); overflow-y: auto; }
        .screen.active { display: flex; }

        /* === START SCREEN === */
        #ss { align-items: center; justify-content: center; gap: 0; position: relative; overflow: hidden; }
        .bg-glow { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(120px); pointer-events: none; opacity: 0.15; }
        .bg-glow.g1 { background: var(--p1); top: -100px; left: -100px; }
        .bg-glow.g2 { background: var(--p2); bottom: -100px; right: -100px; }
        .logo { font-family: 'Bebas Neue'; font-size: 72px; letter-spacing: 4px; background: linear-gradient(135deg, var(--p1) 0%, var(--p2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .tagline { color: var(--mut); font-size: 13px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 48px; }
        .auth-card { background: var(--sur); border: 1px solid #222; border-radius: 20px; padding: 28px 24px; width: 100%; max-width: 340px; text-align: center; }
        .auth-card p { color: var(--mut); font-size: 13px; line-height: 1.6; margin-bottom: 20px; }
        .btn-spotify { background: #1DB954; color: #000; font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 1px; padding: 16px 24px; border: none; border-radius: 50px; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-spotify svg { width: 22px; height: 22px; }
        .setup-form { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
        .input-wrap { background: var(--sur); border: 1px solid #252532; border-radius: 12px; padding: 14px 18px; display: flex; align-items: center; gap: 12px; }
        .player-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .input-wrap input { background: none; border: none; color: #fff; font-size: 16px; outline: none; flex: 1; font-family: 'DM Sans'; }
        input::placeholder { color: var(--mut); }
        .btn-start { background: linear-gradient(135deg, var(--p1), var(--p2)); color: #fff; font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 2px; padding: 18px; border: none; border-radius: 12px; width: 100%; cursor: pointer; margin-top: 4px; }
        .songs-badge { font-size: 11px; color: var(--mut); text-align: center; margin-top: 4px; }
        .spinner { width: 32px; height: 32px; border: 3px solid #222; border-top-color: var(--p1); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === GAME SCREEN === */
        #gs { padding-top: max(env(safe-area-inset-top, 12px), 12px); gap: 0; }

        .hdr { display: flex; justify-content: space-between; align-items: stretch; gap: 8px; margin-bottom: 14px; flex-shrink: 0; }
        .score-pill { flex: 1; background: var(--sur); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid #222; }
        .score-name { font-size: 11px; color: var(--mut); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-num { font-family: 'Bebas Neue'; font-size: 30px; line-height: 1; }
        /* Challenge point dots */
        .cp-row { display: flex; gap: 4px; justify-content: center; margin-top: 5px; }
        .cp-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); transition: all 0.2s; }
        .cp-dot.empty { background: transparent; border: 1px solid #3a3a4a; }

        .turn-pill { background: var(--s2); border-radius: 12px; padding: 10px 14px; text-align: center; border: 1px solid #252532; flex-shrink: 0; }
        .turn-label { font-size: 9px; color: var(--mut); letter-spacing: 1px; text-transform: uppercase; }
        .turn-name { font-family: 'Bebas Neue'; font-size: 16px; white-space: nowrap; }

        .player-wrap { position: relative; height: 80px; border-radius: 12px; overflow: hidden; background: #000; border: 1px solid #1a1a24; flex-shrink: 0; margin-bottom: 14px; }
        .player-mask-top { position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: #000; z-index: 5; display: flex; align-items: center; padding-left: 16px; pointer-events: none; }
        .player-mask-left { position: absolute; top: 0; left: 0; width: 73%; height: 100%; background: #000; z-index: 5; pointer-events: none; }
        .mask-label { font-family: 'Bebas Neue'; font-size: 11px; letter-spacing: 2px; color: #2a2a35; }
        .player-wrap iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .tl-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .tl-scroll::-webkit-scrollbar { display: none; }
        .tins { padding: 10px 16px; border: 2px dashed #2a2a38; border-radius: 10px; text-align: center; color: var(--gold); font-family: 'Bebas Neue'; font-size: 16px; letter-spacing: 1px; cursor: pointer; margin: 5px 0; transition: all 0.15s; background: transparent; }
        .tins:active { background: rgba(255,201,64,0.08); border-color: var(--gold); }
        .tins.locked { opacity: 0.35; cursor: default; pointer-events: none; }
        .tins.blocked { opacity: 0.4; cursor: not-allowed; pointer-events: none; border-color: var(--p1); color: var(--p1); background: rgba(255,45,85,0.05); }
        .tins.blocked::after { content: ' üö´'; font-size: 12px; }

        /* Danceparty button */
        .danceparty-btn { position: fixed; bottom: max(env(safe-area-inset-bottom, 12px), 12px); right: 16px; z-index: 50; background: #111118; border: 1px solid #222; border-radius: 50px; padding: 8px 14px; font-size: 11px; color: #333340; cursor: pointer; font-family: 'DM Sans'; letter-spacing: 0.5px; transition: all 0.2s; }
        .danceparty-btn:active { color: #ff69b4; border-color: #ff69b4; background: rgba(255,105,180,0.08); }
        /* Danceparty modal */
        #danceparty-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.97); display: none; align-items: center; justify-content: center; z-index: 300; flex-direction: column; gap: 16px; }
        #danceparty-modal.open { display: flex; }
        .dp-title { font-family: 'Bebas Neue'; font-size: 42px; letter-spacing: 4px; background: linear-gradient(135deg, #ff69b4, #ff9500, #ffc940); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: dpPulse 1s ease-in-out infinite alternate; }
        @keyframes dpPulse { from { opacity: 0.7; transform: scale(0.97); } to { opacity: 1; transform: scale(1.03); } }
        .dp-sub { font-size: 13px; color: #666; letter-spacing: 1px; }
        .dp-player { width: 300px; height: 80px; border-radius: 12px; overflow: hidden; }
        .dp-player iframe { width: 100%; height: 100%; border: none; }
        .btn-dp-close { background: var(--gray); color: var(--mut); font-family: 'Bebas Neue'; font-size: 16px; letter-spacing: 1px; padding: 12px 28px; border: none; border-radius: 50px; cursor: pointer; }
        .tcard { background: var(--s2); padding: 11px 14px; border-radius: 10px; display: flex; align-items: center; gap: 12px; border-left: 3px solid var(--gold); margin: 3px 0; }
        .tyear { font-family: 'Bebas Neue'; font-size: 26px; color: var(--gold); min-width: 54px; }
        .tinfo strong { font-size: 14px; display: block; }
        .tinfo small { font-size: 11px; color: var(--mut); }

        /* Action panel */
        .action-panel { flex-shrink: 0; background: var(--sur); border-radius: 14px; border: 1px solid #252532; padding: 16px; text-align: center; margin-top: 8px; }
        .phase-badge { display: inline-block; font-family: 'Bebas Neue'; font-size: 11px; letter-spacing: 2px; padding: 4px 12px; border-radius: 50px; margin-bottom: 10px; background: rgba(255,201,64,0.1); color: var(--gold); border: 1px solid rgba(255,201,64,0.25); }
        .panel-title { font-family: 'Bebas Neue'; font-size: 16px; letter-spacing: 1px; margin-bottom: 6px; }
        .panel-sub { font-size: 12px; color: var(--mut); margin-bottom: 14px; line-height: 1.6; }
        .panel-sub strong { color: var(--txt); }
        .btn-correct { background: linear-gradient(135deg, #34c759, #00c8f8); color: #fff; font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 1px; padding: 14px; border: none; border-radius: 10px; width: 100%; cursor: pointer; margin-bottom: 8px; }
        .btn-wrong-guess { background: var(--gray); color: var(--mut); font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 1px; padding: 12px; border: none; border-radius: 10px; width: 100%; cursor: pointer; }
        .btn-steal { background: linear-gradient(135deg, #ff9500, var(--p1)); color: #fff; font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 1px; padding: 14px; border: none; border-radius: 10px; width: 100%; cursor: pointer; margin-bottom: 8px; }
        .btn-steal:disabled { background: #222; color: #444; cursor: not-allowed; }
        .btn-pass { background: var(--gray); color: var(--mut); font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 1px; padding: 12px; border: none; border-radius: 10px; width: 100%; cursor: pointer; margin-top: 8px; }
        .cp-cost-note { font-size: 11px; color: #ff9500; margin-top: 6px; }
        .cp-warning { font-size: 11px; color: var(--p1); margin-top: 6px; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
        .modal.open { display: flex; }
        .modal-card { background: var(--sur); border-radius: 20px; padding: 32px 24px; text-align: center; width: 100%; max-width: 340px; border: 1px solid #222; animation: popIn 0.25s cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes popIn { from { transform: scale(0.85); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .result-badge { display: inline-block; font-family: 'Bebas Neue'; font-size: 13px; letter-spacing: 2px; padding: 6px 16px; border-radius: 50px; margin-bottom: 16px; }
        .result-badge.correct { background: rgba(52,199,89,0.15); color: #34c759; border: 1px solid rgba(52,199,89,0.3); }
        .result-badge.stolen { background: rgba(255,149,0,0.15); color: #ff9500; border: 1px solid rgba(255,149,0,0.3); }
        .result-badge.wrong { background: rgba(255,45,85,0.15); color: var(--p1); border: 1px solid rgba(255,45,85,0.3); }
        .result-year { font-family: 'Bebas Neue'; font-size: 56px; line-height: 1; color: var(--gold); margin-bottom: 4px; }
        .result-song { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .result-artist { font-size: 14px; color: var(--mut); margin-bottom: 12px; }
        .result-details { background: #0d0d14; border-radius: 10px; padding: 10px 14px; margin-bottom: 12px; text-align: left; }
        .result-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 12px; }
        .result-row + .result-row { border-top: 1px solid #1a1a24; }
        .result-row .rr-icon { font-size: 14px; flex-shrink: 0; }
        .result-row .rr-label { color: var(--mut); flex: 1; }
        .result-row .rr-val { font-weight: 700; }
        .rr-val.ok { color: #34c759; }
        .rr-val.fail { color: var(--p1); }
        .rr-val.na { color: #444; }
        .result-bonus { font-size: 12px; color: var(--p2); min-height: 16px; margin-bottom: 16px; font-weight: 500; }
        .btn-next { background: linear-gradient(135deg, var(--p1), var(--p2)); color: #fff; font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 1px; padding: 16px; border: none; border-radius: 12px; width: 100%; cursor: pointer; }

        .searching { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 150; flex-direction: column; gap: 12px; }
        .searching.open { display: flex; }
        .searching p { color: var(--mut); font-size: 13px; }
    </style>
</head>
<body>

<!-- START SCREEN -->
<div id="ss" class="screen active">
    <div class="bg-glow g1"></div>
    <div class="bg-glow g2"></div>
    <div class="logo">MUZIEKSPEL</div>
    <div class="tagline">Raad het jaar ¬∑ Steel de beurt</div>

    <div id="load-status" style="text-align:center">
        <div class="spinner"></div>
        <p style="color:var(--mut);font-size:13px">Laden...</p>
    </div>

    <div id="auth-section" style="display:none">
        <div class="auth-card">
            <p>Log in met Spotify om volledige nummers te spelen. Je hebt <strong style="color:#fff">geen Premium</strong> nodig ‚Äî we gebruiken de gratis ingebouwde Spotify-speler.</p>
            <button class="btn-spotify" onclick="loginWithSpotify()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                VERBIND SPOTIFY
            </button>
        </div>
    </div>

    <div id="setup-form" class="setup-form" style="display:none">
        <div class="input-wrap">
            <div class="player-dot" style="background:var(--p1)"></div>
            <input type="text" id="p1n" placeholder="Naam Speler 1" maxlength="16">
        </div>
        <div class="input-wrap">
            <div class="player-dot" style="background:var(--p2)"></div>
            <input type="text" id="p2n" placeholder="Naam Speler 2" maxlength="16">
        </div>
        <button class="btn-start" onclick="startGame()">SPEEL</button>
        <p class="songs-badge" id="songs-count"></p>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gs" class="screen">
    <div class="hdr">
        <div class="score-pill">
            <div class="score-name" id="hp1n">P1</div>
            <div class="score-num" style="color:var(--p1)" id="hp1s">0</div>
            <div class="cp-row" id="cp1-dots"></div>
        </div>
        <div class="turn-pill">
            <div class="turn-label">Beurt</div>
            <div class="turn-name" id="hturn">‚Äî</div>
        </div>
        <div class="score-pill">
            <div class="score-name" id="hp2n">P2</div>
            <div class="score-num" style="color:var(--p2)" id="hp2s">0</div>
            <div class="cp-row" id="cp2-dots"></div>
        </div>
    </div>

    <div class="player-wrap">
        <div class="player-mask-top"><span class="mask-label">üéµ Raad het jaar</span></div>
        <div class="player-mask-left"></div>
        <div id="spotify-wrapper"></div>
    </div>

    <div class="tl-scroll">
        <div id="active-tl"></div>
    </div>

    <div id="action-panel" class="action-panel" style="display:none"></div>
</div>

<!-- RESULT MODAL -->
<div id="result-modal" class="modal">
    <div class="modal-card">
        <div class="result-badge" id="result-badge">CORRECT</div>
        <div class="result-year" id="rm-year"></div>
        <div class="result-song" id="rm-song"></div>
        <div class="result-artist" id="rm-artist"></div>
        <div class="result-details" id="rm-details"></div>
        <div class="result-bonus" id="rm-bonus"></div>
        <button class="btn-next" onclick="closeModal()">VOLGENDE RONDE ‚Ä∫</button>
    </div>
</div>

<!-- DANCEPARTY MODAL -->
<div id="danceparty-modal">
    <div class="dp-title">üéâ POEPIE'S DANCEPARTY üéâ</div>
    <div class="dp-sub">traag ‚Äî bissy & kraantje pappie</div>
    <div class="dp-player" id="dp-player"></div>
    <button class="btn-dp-close" onclick="closeDanceparty()">SLUIT FEESTJE</button>
</div>

<!-- Danceparty trigger ‚Äî tucked in corner, out of the way -->
<button class="danceparty-btn" onclick="openDanceparty()">üï∫ Poepie's danceparty</button>

<!-- SEARCHING OVERLAY -->
<div id="searching" class="searching">
    <div class="spinner"></div>
    <p>Nummer zoeken op Spotify‚Ä¶</p>
</div>

<script>
const CLIENT_ID = '67388d83797b47cfb921f05009b74c9d';
const REDIRECT_URI = window.location.origin + window.location.pathname;
const GITHUB_URL = 'https://raw.githubusercontent.com/reusensm/muziekspel/main/songsdata.json';

// ==========================================
// STATE
// ==========================================
let ALL_SONGS = [], RAW_SONGS = [];
let SP_TOKEN = '';
let turn = 1;
let p1 = { name: "", score: 0, timeline: [], cp: 2 };
let p2 = { name: "", score: 0, timeline: [], cp: 2 };
let currentSong = null;
let pGuess = -1;
let stealerPlayer = null;
let titleGuessedCorrect = false;

// Phases: 'title' | 'place' | 'steal' | 'steal-place'
let phase = 'title';
// Positions (in opponent's timeline) that are blocked for steal (= same range as active player's guess)
let blockedStealPositions = [];

function computeBlockedStealPositions(curPTimeline, oppTimeline, guessPos) {
    const curSorted = [...curPTimeline].sort((a, b) => a[2] - b[2]);
    const oppSorted = [...oppTimeline].sort((a, b) => a[2] - b[2]);
    let lowYear = -Infinity, highYear = Infinity;
    if (guessPos === 0) {
        highYear = curSorted[0][2];
    } else if (guessPos === curSorted.length) {
        lowYear = curSorted[curSorted.length - 1][2];
    } else {
        lowYear = curSorted[guessPos - 1][2];
        highYear = curSorted[guessPos][2];
    }
    const blocked = [];
    const n = oppSorted.length;
    for (let i = 0; i <= n; i++) {
        const slotLow  = i === 0 ? -Infinity : oppSorted[i - 1][2];
        const slotHigh = i === n ?  Infinity : oppSorted[i][2];
        if (slotLow <= highYear && slotHigh >= lowYear) blocked.push(i);
    }
    return blocked;
}

// ==========================================
// PKCE
// ==========================================
function generateCodeVerifier(len = 64) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let v = ''; const arr = new Uint8Array(len);
    crypto.getRandomValues(arr);
    arr.forEach(b => v += chars[b % chars.length]);
    return v;
}
async function generateCodeChallenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

// ==========================================
// AUTH
// ==========================================
async function loginWithSpotify() {
    const verifier = generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier);
    sessionStorage.setItem('pkce_verifier', verifier);
    const params = new URLSearchParams({
        client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI,
        scope: 'streaming user-read-private user-read-email user-read-playback-state',
        code_challenge_method: 'S256', code_challenge: challenge, show_dialog: 'true'
    });
    window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
}
async function exchangeCode(code) {
    const verifier = sessionStorage.getItem('pkce_verifier');
    const body = new URLSearchParams({ grant_type: 'authorization_code', code, redirect_uri: REDIRECT_URI, client_id: CLIENT_ID, code_verifier: verifier });
    const res = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
    return (await res.json()).access_token;
}

// ==========================================
// SPOTIFY SEARCH
// ==========================================
async function findSpotifyTrack(song) {
    const q = encodeURIComponent(`${song[1]} ${song[0]}`);
    try {
        const r = await fetch(`https://api.spotify.com/v1/search?q=${q}&type=track&limit=3`, { headers: { 'Authorization': `Bearer ${SP_TOKEN}` } });
        const d = await r.json();
        const items = d.tracks?.items || [];
        const year = song[2];
        const byYear = items.find(t => Math.abs(parseInt(t.album?.release_date?.substring(0, 4)) - year) <= 2);
        return (byYear || items[0])?.id || null;
    } catch { return null; }
}

// ==========================================
// INIT
// ==========================================
async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    loadSongs();
    if (code) {
        try {
            SP_TOKEN = await exchangeCode(code);
            sessionStorage.removeItem('pkce_verifier');
            window.history.replaceState({}, document.title, window.location.pathname);
            showSetup();
        } catch { showAuth(); }
    } else { showAuth(); }
}

async function loadSongs() {
    try {
        const res = await fetch(GITHUB_URL);
        ALL_SONGS = await res.json();
    } catch {
        ALL_SONGS = [
            ["Bohemian Rhapsody","Queen",1975],["Billie Jean","Michael Jackson",1982],
            ["Like a Rolling Stone","Bob Dylan",1965],["Smells Like Teen Spirit","Nirvana",1991],
            ["Hey Jude","The Beatles",1968],["Purple Rain","Prince",1984],
            ["Born to Run","Bruce Springsteen",1975],["Wonderwall","Oasis",1995],
            ["Hotel California","Eagles",1977],["Mr. Brightside","The Killers",2003],
            ["Seven Nation Army","The White Stripes",2003],["Creep","Radiohead",1992],
            ["One More Time","Daft Punk",2000],["Sweet Child O Mine","Guns N Roses",1987],
            ["Africa","Toto",1982],["Take On Me","A-ha",1985],["Dancing Queen","ABBA",1976],
            ["Bad Guy","Billie Eilish",2019],["Shape of You","Ed Sheeran",2017],
            ["Blinding Lights","The Weeknd",2019],["Rolling in the Deep","Adele",2010],
            ["Uptown Funk","Mark Ronson",2014],["Shake It Off","Taylor Swift",2014],
            ["Get Lucky","Daft Punk",2013],["Somebody That I Used to Know","Gotye",2011]
        ];
    }
    RAW_SONGS = [...ALL_SONGS];
    const el = document.getElementById('songs-count');
    if (el) el.textContent = `${ALL_SONGS.length} nummers geladen`;
}

function showAuth() {
    document.getElementById('load-status').style.display = 'none';
    document.getElementById('auth-section').style.display = 'block';
}
function showSetup() {
    document.getElementById('load-status').style.display = 'none';
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('setup-form').style.display = 'flex';
}

// ==========================================
// GAME FLOW
// ==========================================
function startGame() {
    if (!ALL_SONGS.length) { alert('Nummers nog niet geladen...'); return; }
    p1.name = document.getElementById('p1n').value.trim() || 'Speler 1';
    p2.name = document.getElementById('p2n').value.trim() || 'Speler 2';
    p1.score = 0; p1.timeline = []; p1.cp = 2;
    p2.score = 0; p2.timeline = []; p2.cp = 2;
    RAW_SONGS = [...ALL_SONGS];
    p1.timeline.push(RAW_SONGS.splice(Math.floor(Math.random() * RAW_SONGS.length), 1)[0]);
    p2.timeline.push(RAW_SONGS.splice(Math.floor(Math.random() * RAW_SONGS.length), 1)[0]);
    turn = 1;
    nextRound();
}

async function nextRound() {
    if (!RAW_SONGS.length) RAW_SONGS = [...ALL_SONGS];
    currentSong = RAW_SONGS.splice(Math.floor(Math.random() * RAW_SONGS.length), 1)[0];
    stealerPlayer = null;
    pGuess = -1;
    titleGuessedCorrect = false;
    blockedStealPositions = [];
    phase = 'title';

    updateHeader();
    document.getElementById('action-panel').style.display = 'none';

    document.getElementById('searching').classList.add('open');
    const tid = await findSpotifyTrack(currentSong);
    document.getElementById('searching').classList.remove('open');

    document.getElementById('spotify-wrapper').innerHTML = tid
        ? `<iframe src="https://open.spotify.com/embed/track/${tid}?utm_source=generator&autoplay=1&theme=0" width="100%" height="80" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`
        : `<div style="height:80px;display:flex;align-items:center;justify-content:center;color:#444;font-size:12px">Nummer niet gevonden op Spotify</div>`;

    renderTimeline();
    showTitlePhase();
    showScreen('gs');
}

function updateHeader() {
    const curP = turn === 1 ? p1 : p2;
    document.getElementById('hturn').textContent = curP.name;
    document.getElementById('hp1n').textContent = p1.name;
    document.getElementById('hp2n').textContent = p2.name;
    document.getElementById('hp1s').textContent = p1.score;
    document.getElementById('hp2s').textContent = p2.score;
    renderCpDots('cp1-dots', p1.cp);
    renderCpDots('cp2-dots', p2.cp);
}

function renderCpDots(elId, cp) {
    const el = document.getElementById(elId);
    // Show max(cp, 2) slots so you always see at least 2
    const slots = Math.max(cp, 2);
    el.innerHTML = Array.from({length: slots}, (_, i) =>
        `<div class="cp-dot ${i < cp ? '' : 'empty'}"></div>`
    ).join('');
}

// ==========================================
// PHASE 1: TITLE GUESS
// ==========================================
function showTitlePhase() {
    const curP = turn === 1 ? p1 : p2;
    const panel = document.getElementById('action-panel');
    panel.style.display = 'block';
    panel.innerHTML = `
        <div class="phase-badge">üé§ STAP 1 ‚Äî TITEL & ARTIEST</div>
        <div class="panel-title">${curP.name}, raad hardop!</div>
        <div class="panel-sub">Wat is de <strong>titel</strong> en <strong>artiest</strong> van dit nummer?<br><small style="color:#3a3a4a">Correct = +1 challengepunt üèÖ</small></div>
        <button class="btn-correct" onclick="onTitleResult(true)">‚úì CORRECT GERADEN</button>
        <button class="btn-wrong-guess" onclick="onTitleResult(false)">‚úó NIET GERADEN</button>
    `;
}

function onTitleResult(correct) {
    titleGuessedCorrect = correct;
    phase = 'place';
    const panel = document.getElementById('action-panel');
    const curP = turn === 1 ? p1 : p2;
    panel.innerHTML = `
        <div class="phase-badge">üìÖ STAP 2 ‚Äî TIJDLIJN</div>
        <div class="panel-sub"><strong>${curP.name}</strong>, tik op de juiste plek in jouw tijdlijn.</div>
    `;
    renderTimeline();
}

// ==========================================
// PHASE 2: TIMELINE PLACEMENT
// ==========================================
function renderTimeline() {
    const tl = document.getElementById('active-tl');
    const clickable = (phase === 'place' || phase === 'steal-place');
    const usePlayer = phase === 'steal-place' ? stealerPlayer : (turn === 1 ? p1 : p2);
    const sorted = [...usePlayer.timeline].sort((a, b) => a[2] - b[2]);

    const slot = (pos, label) => {
        if (!clickable) return `<div class="tins locked">${label}</div>`;
        if (phase === 'steal-place' && blockedStealPositions.includes(pos)) {
            return `<div class="tins blocked" title="Zelfde plek als de gok van de speler ‚Äî niet toegestaan!">${label}</div>`;
        }
        return `<div class="tins" onclick="handlePick(${pos})">${label}</div>`;
    };

    let h = slot(0, `‚¨áÔ∏è VOOR ${sorted[0][2]}`);
    sorted.forEach((s, i) => {
        h += `<div class="tcard">
            <span class="tyear">${s[2]}</span>
            <div class="tinfo"><strong>${s[0]}</strong><small>${s[1]}</small></div>
        </div>`;
        if (i < sorted.length - 1) {
            h += slot(i + 1, `‚ÜïÔ∏è ${sorted[i][2]}‚Äì${sorted[i+1][2]}`);
        }
    });
    h += slot(sorted.length, `‚¨ÜÔ∏è NA ${sorted[sorted.length-1][2]}`);
    tl.innerHTML = h;
}

function handlePick(pos) {
    if (phase === 'place') {
        pGuess = pos;
        // Compute which positions in opponent's timeline are blocked for stealing
        const curP = turn === 1 ? p1 : p2;
        const opp  = turn === 1 ? p2 : p1;
        blockedStealPositions = computeBlockedStealPositions(curP.timeline, opp.timeline, pGuess);
        showStealPhase();
    } else if (phase === 'steal-place') {
        resolveRound(true, pos);
    }
}

// ==========================================
// PHASE 3: STEAL OFFER
// ==========================================
function showStealPhase() {
    phase = 'steal';
    const opp = turn === 1 ? p2 : p1;
    const canSteal = opp.cp > 0;
    const panel = document.getElementById('action-panel');
    panel.innerHTML = `
        <div class="phase-badge">üî• STAP 3 ‚Äî CHALLENGE</div>
        <div class="panel-title">${opp.name}: wil jij stelen?</div>
        <div class="panel-sub">Je hebt <strong>${opp.cp} challengepunt${opp.cp !== 1 ? 'en' : ''}</strong>. Stelen kost altijd 1 punt ‚Äî ook als je fout zit.</div>
        <button class="btn-steal" ${canSteal ? '' : 'disabled'} onclick="activateStealing()">üî• JA, IK STEEL! (‚àí1 punt)</button>
        ${canSteal
            ? `<p class="cp-cost-note">1 punt wordt direct afgetrokken.</p>`
            : `<p class="cp-warning">Geen challengepunten meer!</p>`}
        <button class="btn-pass" onclick="resolveRound(false, null)">PASSEN</button>
    `;
    renderTimeline(); // lock the slots
}

function activateStealing() {
    stealerPlayer = turn === 1 ? p2 : p1;
    stealerPlayer.cp = Math.max(0, stealerPlayer.cp - 1);
    updateHeader();
    phase = 'steal-place';
    const panel = document.getElementById('action-panel');
    panel.innerHTML = `
        <div class="phase-badge">üî• STEEL-MODUS</div>
        <div class="panel-sub"><strong>${stealerPlayer.name}</strong>, tik op de juiste plek in <em>jouw</em> tijdlijn.</div>
    `;
    renderTimeline();
    document.querySelector('.tl-scroll').scrollTop = 0;
}

// ==========================================
// RESOLVE
// ==========================================
function isCorrectPlacement(timeline, pos, year) {
    const sorted = [...timeline].sort((a, b) => a[2] - b[2]);
    if (pos === 0) return year <= sorted[0][2];
    if (pos === sorted.length) return year >= sorted[sorted.length-1][2];
    return year >= sorted[pos-1][2] && year <= sorted[pos][2];
}

function resolveRound(stealAttempted, stealPos) {
    const curP = turn === 1 ? p1 : p2;
    const opp   = turn === 1 ? p2 : p1;
    const year  = currentSong[2];

    const originalCorrect = isCorrectPlacement(curP.timeline, pGuess, year);
    const stealCorrect    = stealAttempted && stealPos !== null
                            && isCorrectPlacement(opp.timeline, stealPos, year);

    let resultType, badge, bonusMsg = '';
    document.getElementById('spotify-wrapper').innerHTML = '';

    if (originalCorrect) {
        curP.score++;
        curP.timeline.push(currentSong);
        resultType = 'correct';
        badge = '‚úì CORRECT!';
        if (titleGuessedCorrect) {
            curP.cp++;
            bonusMsg = `üèÖ +1 challengepunt voor ${curP.name}!`;
        }
    } else if (stealCorrect) {
        opp.score++;
        opp.timeline.push(currentSong);
        resultType = 'stolen';
        badge = 'üî• GESTOLEN!';
    } else {
        resultType = 'wrong';
        badge = '‚úó FOUT!';
    }

    // Build detail rows
    const activeRow = `
        <div class="result-row">
            <span class="rr-icon">${originalCorrect ? '‚úÖ' : '‚ùå'}</span>
            <span class="rr-label">${curP.name} (tijdlijn)</span>
            <span class="rr-val ${originalCorrect ? 'ok' : 'fail'}">${originalCorrect ? 'JUIST' : 'FOUT'}</span>
        </div>`;

    let stealRow = '';
    if (stealAttempted) {
        stealRow = `
        <div class="result-row">
            <span class="rr-icon">${stealCorrect ? 'üî•' : 'üí®'}</span>
            <span class="rr-label">${opp.name} (steal)</span>
            <span class="rr-val ${stealCorrect ? 'ok' : 'fail'}">${stealCorrect ? 'GESTOLEN' : 'GEMIST'}</span>
        </div>`;
    } else {
        stealRow = `
        <div class="result-row">
            <span class="rr-icon">ü§∑</span>
            <span class="rr-label">${opp.name} (geen challenge)</span>
            <span class="rr-val na">GEPAST</span>
        </div>`;
    }

    document.getElementById('result-badge').textContent = badge;
    document.getElementById('result-badge').className = 'result-badge ' + resultType;
    document.getElementById('rm-year').textContent = year;
    document.getElementById('rm-song').textContent = currentSong[0];
    document.getElementById('rm-artist').textContent = currentSong[1];
    document.getElementById('rm-details').innerHTML = activeRow + stealRow;
    document.getElementById('rm-bonus').textContent = bonusMsg;
    document.getElementById('result-modal').classList.add('open');
    updateHeader();
}

function closeModal() {
    document.getElementById('result-modal').classList.remove('open');
    turn = turn === 1 ? 2 : 1;
    nextRound();
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ==========================================
// POEPIE'S DANCEPARTY
// ==========================================
async function openDanceparty() {
    const modal = document.getElementById('danceparty-modal');
    modal.classList.add('open');
    const dpPlayer = document.getElementById('dp-player');
    dpPlayer.innerHTML = `<div style="height:80px;display:flex;align-items:center;justify-content:center;color:#555;font-size:12px"><div class="spinner"></div></div>`;

    // Search for "Traag Bissy Kraantje Pappie"
    try {
        const q = encodeURIComponent('Traag Bissy Kraantje Pappie');
        const r = await fetch(`https://api.spotify.com/v1/search?q=${q}&type=track&limit=5`, {
            headers: { 'Authorization': `Bearer ${SP_TOKEN}` }
        });
        const d = await r.json();
        const track = d.tracks?.items?.[0];
        if (track) {
            dpPlayer.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${track.id}?utm_source=generator&autoplay=1&theme=0" width="100%" height="80" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`;
        } else {
            dpPlayer.innerHTML = `<div style="height:80px;display:flex;align-items:center;justify-content:center;color:#555;font-size:12px">Nummer niet gevonden üò¢</div>`;
        }
    } catch {
        dpPlayer.innerHTML = `<div style="height:80px;display:flex;align-items:center;justify-content:center;color:#555;font-size:12px">Fout bij laden üò¢</div>`;
    }
}

function closeDanceparty() {
    document.getElementById('danceparty-modal').classList.remove('open');
    document.getElementById('dp-player').innerHTML = '';
}

init();
</script>
</body>
</html>