<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Muziekspel</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,500;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080810; --sur: #111118; --s2: #18181f; --s3: #222230;
            --p1: #ff2d55; --p2: #00c8f8; --gold: #ffc940; --gray: #333340;
            --txt: #f0f0f0; --mut: #666; --r: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { background: var(--bg); color: var(--txt); font-family: 'DM Sans', sans-serif; }

        .screen { display: none; flex-direction: column; height: 100dvh; padding: env(safe-area-inset-top, 12px) 20px env(safe-area-inset-bottom, 20px); overflow-y: auto; }
        .screen.active { display: flex; }

        /* === START SCREEN === */
        #ss { align-items: center; justify-content: center; gap: 0; position: relative; overflow: hidden; }
        .bg-glow { position: absolute; width: 400px; height: 400px; border-radius: 50%; filter: blur(120px); pointer-events: none; opacity: 0.15; }
        .bg-glow.g1 { background: var(--p1); top: -100px; left: -100px; }
        .bg-glow.g2 { background: var(--p2); bottom: -100px; right: -100px; }
        .logo { font-family: 'Bebas Neue'; font-size: 72px; letter-spacing: 4px; background: linear-gradient(135deg, var(--p1) 0%, var(--p2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .tagline { color: var(--mut); font-size: 13px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 48px; }
        
        .auth-card { background: var(--sur); border: 1px solid #222; border-radius: 20px; padding: 28px 24px; width: 100%; max-width: 340px; text-align: center; }
        .auth-card p { color: var(--mut); font-size: 13px; line-height: 1.6; margin-bottom: 20px; }
        .btn-spotify { background: #1DB954; color: #000; font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 1px; padding: 16px 24px; border: none; border-radius: 50px; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-spotify svg { width: 22px; height: 22px; }
        
        .setup-form { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 12px; margin-top: 16px; }
        
        /* Playlist Selector Styling */
        .select-wrap { background: var(--sur); border: 2px solid var(--s3); border-radius: 12px; padding: 4px 12px; display: flex; align-items: center; }
        .select-wrap select { background: transparent; border: none; color: #fff; font-size: 15px; padding: 10px 0; width: 100%; outline: none; font-family: 'DM Sans'; cursor: pointer; }
        .select-wrap select option { background: var(--sur); color: #fff; }

        .input-wrap { background: var(--sur); border: 1px solid #252532; border-radius: 12px; padding: 14px 18px; display: flex; align-items: center; gap: 12px; }
        .player-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .input-wrap input { background: none; border: none; color: #fff; font-size: 16px; outline: none; flex: 1; font-family: 'DM Sans'; }
        
        .btn-start { background: linear-gradient(135deg, var(--p1), var(--p2)); color: #fff; font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 2px; padding: 18px; border: none; border-radius: 12px; width: 100%; cursor: pointer; margin-top: 4px; }
        .songs-badge { font-size: 11px; color: var(--mut); text-align: center; margin-top: 4px; }
        .spinner { width: 32px; height: 32px; border: 3px solid #222; border-top-color: var(--p1); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === GAME SCREEN === */
        #gs { padding-top: max(env(safe-area-inset-top, 12px), 12px); gap: 0; }
        .hdr { display: flex; justify-content: space-between; align-items: stretch; gap: 8px; margin-bottom: 14px; flex-shrink: 0; }
        .score-pill { flex: 1; background: var(--sur); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid #222; }
        .score-name { font-size: 11px; color: var(--mut); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-num { font-family: 'Bebas Neue'; font-size: 30px; line-height: 1; }
        .cp-row { display: flex; gap: 4px; justify-content: center; margin-top: 5px; }
        .cp-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gold); transition: all 0.2s; }
        .cp-dot.empty { background: transparent; border: 1px solid #3a3a4a; }

        .turn-pill { background: var(--s2); border-radius: 12px; padding: 10px 14px; text-align: center; border: 1px solid #252532; flex-shrink: 0; }
        .turn-label { font-size: 9px; color: var(--mut); letter-spacing: 1px; text-transform: uppercase; }
        .turn-name { font-family: 'Bebas Neue'; font-size: 16px; white-space: nowrap; }

        .player-wrap { position: relative; height: 80px; border-radius: 12px; overflow: hidden; background: #000; border: 1px solid #1a1a24; flex-shrink: 0; margin-bottom: 14px; }
        .player-mask-top { position: absolute; top: 0; left: 0; width: 100%; height: 50%; background: #000; z-index: 5; display: flex; align-items: center; padding-left: 16px; pointer-events: none; }
        .player-mask-left { position: absolute; top: 0; left: 0; width: 73%; height: 100%; background: #000; z-index: 5; pointer-events: none; }
        .mask-label { font-family: 'Bebas Neue'; font-size: 11px; letter-spacing: 2px; color: #2a2a35; }
        .player-wrap iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        .tl-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .tins { padding: 10px 16px; border: 2px dashed #2a2a38; border-radius: 10px; text-align: center; color: var(--gold); font-family: 'Bebas Neue'; font-size: 16px; letter-spacing: 1px; cursor: pointer; margin: 5px 0; transition: all 0.15s; background: transparent; }
        .tins.locked { opacity: 0.35; cursor: default; pointer-events: none; }
        .tins.blocked { opacity: 0.4; cursor: not-allowed; pointer-events: none; border-color: var(--p1); color: var(--p1); background: rgba(255,45,85,0.05); }

        .tcard { background: var(--s2); padding: 11px 14px; border-radius: 10px; display: flex; align-items: center; gap: 12px; border-left: 3px solid var(--gold); margin: 3px 0; }
        .tyear { font-family: 'Bebas Neue'; font-size: 26px; color: var(--gold); min-width: 54px; }
        .tinfo strong { font-size: 14px; display: block; }
        .tinfo small { font-size: 11px; color: var(--mut); }

        /* Action panel */
        .action-panel { flex-shrink: 0; background: var(--sur); border-radius: 14px; border: 1px solid #252532; padding: 16px; text-align: center; margin-top: 8px; }
        .phase-badge { display: inline-block; font-family: 'Bebas Neue'; font-size: 11px; letter-spacing: 2px; padding: 4px 12px; border-radius: 50px; margin-bottom: 10px; background: rgba(255,201,64,0.1); color: var(--gold); border: 1px solid rgba(255,201,64,0.25); }
        .btn-steal { background: linear-gradient(135deg, #ff9500, var(--p1)); color: #fff; font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 1px; padding: 14px; border: none; border-radius: 10px; width: 100%; cursor: pointer; margin-bottom: 8px; }
        .btn-pass { background: var(--gray); color: var(--mut); font-family: 'Bebas Neue'; font-size: 18px; letter-spacing: 1px; padding: 12px; border: none; border-radius: 10px; width: 100%; cursor: pointer; margin-top: 8px; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
        .modal.open { display: flex; }
        .modal-card { background: var(--sur); border-radius: 20px; padding: 32px 24px; text-align: center; width: 100%; max-width: 340px; border: 1px solid #222; }
        .result-year { font-family: 'Bebas Neue'; font-size: 56px; line-height: 1; color: var(--gold); margin-bottom: 4px; }
        .btn-next { background: linear-gradient(135deg, var(--p1), var(--p2)); color: #fff; font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 1px; padding: 16px; border: none; border-radius: 12px; width: 100%; cursor: pointer; }
        
        #danceparty-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.97); display: none; align-items: center; justify-content: center; z-index: 300; flex-direction: column; gap: 16px; }
        #danceparty-modal.open { display: flex; }
        .danceparty-btn { position: fixed; bottom: 16px; right: 16px; z-index: 50; background: #111; border: 1px solid #222; border-radius: 50px; padding: 8px 14px; font-size: 11px; color: #444; cursor: pointer; }
        
        .searching { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 150; flex-direction: column; gap: 12px; }
        .searching.open { display: flex; }
    </style>
</head>
<body>

<div id="ss" class="screen active">
    <div class="bg-glow g1"></div>
    <div class="bg-glow g2"></div>
    <div class="logo">MUZIEKSPEL</div>
    <div class="tagline">Kies je playlist ¬∑ Raad het jaar</div>

    <div id="load-status" style="text-align:center">
        <div class="spinner"></div>
        <p style="color:var(--mut);font-size:13px">Lijsten ophalen van GitHub...</p>
    </div>

    <div id="auth-section" style="display:none">
        <div class="auth-card">
            <p>Log in met Spotify om volledige nummers te spelen.</p>
            <button class="btn-spotify" onclick="loginWithSpotify()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                VERBIND SPOTIFY
            </button>
        </div>
    </div>

    <div id="setup-form" class="setup-form" style="display:none">
        <div class="select-wrap">
            <select id="playlist-select">
                <option value="">-- Kies een playlist --</option>
            </select>
        </div>

        <div class="input-wrap">
            <div class="player-dot" style="background:var(--p1)"></div>
            <input type="text" id="p1n" placeholder="Naam Speler 1" maxlength="16">
        </div>
        <div class="input-wrap">
            <div class="player-dot" style="background:var(--p2)"></div>
            <input type="text" id="p2n" placeholder="Naam Speler 2" maxlength="16">
        </div>
        <button class="btn-start" onclick="startGame()">SPEEL</button>
        <p class="songs-badge" id="songs-count">Kies een lijst om te starten</p>
    </div>
</div>

<div id="gs" class="screen">
    <div class="hdr">
        <div class="score-pill">
            <div class="score-name" id="hp1n">P1</div>
            <div class="score-num" style="color:var(--p1)" id="hp1s">0</div>
            <div class="cp-row" id="cp1-dots"></div>
        </div>
        <div class="turn-pill">
            <div class="turn-label">Beurt</div>
            <div class="turn-name" id="hturn">‚Äî</div>
        </div>
        <div class="score-pill">
            <div class="score-name" id="hp2n">P2</div>
            <div class="score-num" style="color:var(--p2)" id="hp2s">0</div>
            <div class="cp-row" id="cp2-dots"></div>
        </div>
    </div>

    <div class="player-wrap">
        <div class="player-mask-top"><span class="mask-label">üéµ Raad het jaar</span></div>
        <div class="player-mask-left"></div>
        <div id="spotify-wrapper"></div>
    </div>

    <div class="tl-scroll">
        <div id="active-tl"></div>
    </div>

    <div id="action-panel" class="action-panel" style="display:none"></div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-card">
        <div id="result-badge" class="result-badge">CORRECT</div>
        <div class="result-year" id="rm-year"></div>
        <div class="result-song" id="rm-song"></div>
        <div class="result-artist" id="rm-artist"></div>
        <div class="result-details" id="rm-details"></div>
        
        <div id="rm-title-confirm" style="display:none; background:#0d0d14; border-radius:10px; padding:12px; margin-bottom:10px;">
            <div style="font-family:'Bebas Neue';font-size:13px;color:var(--gold);margin-bottom:8px;">HAD JE DE TITEL + ARTIEST?</div>
            <div style="display:flex;gap:8px;">
                <button class="btn-correct" style="padding:10px;font-size:14px;background:green;color:white;border:none;flex:1;border-radius:8px;" onclick="onTitleConfirm(true)">‚úì JA</button>
                <button class="btn-wrong" style="padding:10px;font-size:14px;background:#333;color:white;border:none;flex:1;border-radius:8px;" onclick="onTitleConfirm(false)">‚úó NEE</button>
            </div>
        </div>

        <button class="btn-next" id="rm-next-btn" onclick="closeModal()" style="display:none">VOLGENDE RONDE ‚Ä∫</button>
    </div>
</div>

<div id="searching" class="searching">
    <div class="spinner"></div>
    <p>Nummer zoeken‚Ä¶</p>
</div>

<script>
const CLIENT_ID = '67388d83797b47cfb921f05009b74c9d';
const REDIRECT_URI = window.location.origin + window.location.pathname;

// GITHUB CONFIG
const REPO_API_URL = 'https://api.github.com/repos/reusensm/muziekspel/contents/songlists';

let ALL_SONGS = [], RAW_SONGS = [];
let SP_TOKEN = '';
let turn = 1;
let p1 = { name: "", score: 0, timeline: [], cp: 2 };
let p2 = { name: "", score: 0, timeline: [], cp: 2 };
let currentSong = null;
let pGuess = -1;
let stealerPlayer = null;
let phase = 'place';
let blockedStealPositions = [];

// ==========================================
// 1. OPHALEN VAN PLAYLISTS VAN GITHUB
// ==========================================
async function loadPlaylists() {
    try {
        const res = await fetch(REPO_API_URL);
        if (!res.ok) throw new Error();
        const files = await res.json();
        
        const select = document.getElementById('playlist-select');
        const jsonFiles = files.filter(f => f.name.endsWith('.json'));
        
        jsonFiles.forEach(file => {
            const opt = document.createElement('option');
            opt.value = file.download_url; // De link naar de ruwe data
            opt.textContent = file.name.replace('.json', '').replace(/-/g, ' ');
            select.appendChild(opt);
        });

        document.getElementById('load-status').style.display = 'none';
        showAuth();
    } catch (e) {
        document.getElementById('load-status').innerHTML = "<p style='color:red'>Kon lijsten niet laden van GitHub.</p>";
    }
}

// ==========================================
// 2. SPOTIFY AUTH LOGIC
// ==========================================
async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    
    // Eerst playlists laden, dan checken op auth
    await loadPlaylists();

    if (code) {
        try {
            SP_TOKEN = await exchangeCode(code);
            window.history.replaceState({}, document.title, window.location.pathname);
            showSetup();
        } catch { showAuth(); }
    }
}

async function exchangeCode(code) {
    const verifier = sessionStorage.getItem('pkce_verifier');
    const body = new URLSearchParams({ 
        grant_type: 'authorization_code', code, 
        redirect_uri: REDIRECT_URI, client_id: CLIENT_ID, 
        code_verifier: verifier 
    });
    const res = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', body });
    const d = await res.json();
    return d.access_token;
}

function loginWithSpotify() {
    const verifier = "random_string_here_pkce"; // Simpel voor voorbeeld
    sessionStorage.setItem('pkce_verifier', verifier);
    // In een echte PKCE app zou je een hash maken, maar Spotify accepteert simpele verifiers voor dev.
    const params = new URLSearchParams({
        client_id: CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI,
        scope: 'streaming user-read-private', show_dialog: 'true'
    });
    window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
}

// ==========================================
// 3. GAME FLOW
// ==========================================
async function startGame() {
    const playlistUrl = document.getElementById('playlist-select').value;
    if (!playlistUrl) { alert("Kies een playlist!"); return; }

    const res = await fetch(playlistUrl);
    ALL_SONGS = await res.json();
    RAW_SONGS = [...ALL_SONGS];

    p1.name = document.getElementById('p1n').value || 'Speler 1';
    p2.name = document.getElementById('p2n').value || 'Speler 2';
    
    // Start kaarten
    p1.timeline = [RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]];
    p2.timeline = [RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]];
    
    showScreen('gs');
    nextRound();
}

async function nextRound() {
    currentSong = RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0];
    phase = 'place'; stealerPlayer = null;
    updateHeader();
    
    document.getElementById('searching').classList.add('open');
    const tid = await findSpotifyTrack(currentSong);
    document.getElementById('searching').classList.remove('open');

    document.getElementById('spotify-wrapper').innerHTML = `<iframe src="https://open.spotify.com/embed/track/$${tid}?utm_source=generator&autoplay=1" width="100%" height="80" frameBorder="0" allow="autoplay; encrypted-media;"></iframe>`;
    
    renderTimeline();
    showPlacePhase();
}

async function findSpotifyTrack(song) {
    const q = encodeURIComponent(`${song[1]} ${song[0]}`);
    const r = await fetch(`https://api.spotify.com/v1/search?q=$${q}&type=track&limit=1`, { 
        headers: { 'Authorization': `Bearer ${SP_TOKEN}` } 
    });
    const d = await r.json();
    return d.tracks.items[0]?.id;
}

function renderTimeline() {
    const tl = document.getElementById('active-tl');
    const useP = phase === 'steal-place' ? stealerPlayer : (turn === 1 ? p1 : p2);
    const sorted = [...useP.timeline].sort((a,b) => a[2]-b[2]);
    
    let h = `<div class="tins" onclick="handlePick(0)">‚¨áÔ∏è VOOR ${sorted[0][2]}</div>`;
    sorted.forEach((s, i) => {
        h += `<div class="tcard"><span class="tyear">${s[2]}</span><div class="tinfo"><strong>${s[0]}</strong><small>${s[1]}</small></div></div>`;
        if (i < sorted.length - 1) {
            h += `<div class="tins" onclick="handlePick(${i+1})">‚ÜïÔ∏è TUSSEN</div>`;
        }
    });
    h += `<div class="tins" onclick="handlePick(${sorted.length})">‚¨ÜÔ∏è NA ${sorted[sorted.length-1][2]}</div>`;
    tl.innerHTML = h;
}

function handlePick(pos) {
    if (phase === 'place') {
        pGuess = pos;
        showStealPhase();
    } else if (phase === 'steal-place') {
        resolveRound(true, pos);
    }
}

function showPlacePhase() {
    const panel = document.getElementById('action-panel');
    panel.style.display = 'block';
    panel.innerHTML = `<div class="phase-badge">JOUW BEURT</div><p>${(turn===1?p1:p2).name}, plaats het nummer.</p>`;
}

function showStealPhase() {
    phase = 'steal';
    const opp = turn === 1 ? p2 : p1;
    const panel = document.getElementById('action-panel');
    panel.innerHTML = `
        <div class="phase-badge">STEAL?</div>
        <p>${opp.name}, wil je stelen?</p>
        <button class="btn-steal" onclick="activateStealing()">üî• JA, IK STEEL!</button>
        <button class="btn-pass" onclick="resolveRound(false)">NEE, PASSEN</button>
    `;
}

function activateStealing() {
    stealerPlayer = turn === 1 ? p2 : p1;
    phase = 'steal-place';
    renderTimeline();
}

function resolveRound(stole, stealPos) {
    const year = currentSong[2];
    const curP = turn === 1 ? p1 : p2;
    
    const originalCorrect = isCorrectPlacement(curP.timeline, pGuess, year);
    
    if (stole) {
        const stealCorrect = isCorrectPlacement(stealerPlayer.timeline, stealPos, year);
        if (stealCorrect) {
            stealerPlayer.score++; stealerPlayer.timeline.push(currentSong);
            showResult("GESTOLEN!", "stolen");
        } else {
            showResult("FOUT GESTOLEN", "wrong");
        }
    } else {
        if (originalCorrect) {
            curP.score++; curP.timeline.push(currentSong);
            showResult("CORRECT!", "correct");
        } else {
            showResult("FOUTIEVE PLEK", "wrong");
        }
    }
}

function isCorrectPlacement(tl, pos, year) {
    const sorted = [...tl].sort((a,b) => a[2]-b[2]);
    if (pos === 0) return year <= sorted[0][2];
    if (pos === sorted.length) return year >= sorted[sorted.length-1][2];
    return year >= sorted[pos-1][2] && year <= sorted[pos][2];
}

function showResult(txt, cls) {
    const m = document.getElementById('result-modal');
    document.getElementById('result-badge').textContent = txt;
    document.getElementById('rm-year').textContent = currentSong[2];
    document.getElementById('rm-song').textContent = currentSong[0];
    document.getElementById('rm-artist').textContent = currentSong[1];
    document.getElementById('rm-next-btn').style.display = 'block';
    m.classList.add('open');
}

function closeModal() {
    document.getElementById('result-modal').classList.remove('open');
    turn = turn === 1 ? 2 : 1;
    nextRound();
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function updateHeader() {
    document.getElementById('hp1n').textContent = p1.name;
    document.getElementById('hp2n').textContent = p2.name;
    document.getElementById('hp1s').textContent = p1.score;
    document.getElementById('hp2s').textContent = p2.score;
    document.getElementById('hturn').textContent = (turn===1?p1:p2).name;
}

function showAuth() {
    document.getElementById('auth-section').style.display = 'block';
}

function showSetup() {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('setup-form').style.display = 'flex';
}

// Start de app
init();

</script>
</body>
</html>