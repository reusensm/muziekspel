<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muziekspel - Hitster Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080810; --sur: #111118; --s2: #18181f; --s3: #222230;
            --p1: #ff2d55; --p2: #00c8f8; --gold: #ffc940; --gray: #333340;
            --txt: #f0f0f0; --mut: #666; --r: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { background: var(--bg); color: var(--txt); font-family: 'DM Sans', sans-serif; }

        .screen { display: none; flex-direction: column; height: 100dvh; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; }

        /* START SCREEN */
        #ss { align-items: center; justify-content: center; text-align: center; }
        .logo { font-family: 'Bebas Neue'; font-size: 72px; background: linear-gradient(135deg, var(--p1), var(--p2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .tagline { color: var(--mut); font-size: 12px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; }
        
        .auth-card, .setup-form { background: var(--sur); border: 1px solid var(--s3); border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; }
        .btn-spotify { background: #1DB954; color: black; font-weight: bold; border: none; padding: 15px; border-radius: 50px; width: 100%; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        
        .select-wrap, .input-wrap { background: var(--bg); border: 1px solid var(--s3); border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; }
        select, input { background: transparent; border: none; color: white; width: 100%; outline: none; font-family: 'DM Sans'; font-size: 16px; }
        
        .btn-start { background: linear-gradient(135deg, var(--p1), var(--p2)); color: white; font-family: 'Bebas Neue'; font-size: 24px; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; margin-top: 10px; }

        /* GAME ELEMENTS */
        .hdr { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score-pill { background: var(--sur); padding: 10px; border-radius: 12px; flex: 1; text-align: center; margin: 0 5px; border: 1px solid var(--s3); }
        .score-num { font-family: 'Bebas Neue'; font-size: 32px; line-height: 1; }
        
        .player-wrap { height: 80px; background: black; border-radius: 12px; position: relative; overflow: hidden; margin-bottom: 20px; }
        .player-mask { position: absolute; inset: 0; background: black; z-index: 10; display: flex; align-items: center; padding-left: 20px; color: var(--mut); font-family: 'Bebas Neue'; pointer-events: none; }
        
        .tins { padding: 15px; border: 2px dashed var(--s3); border-radius: 12px; text-align: center; color: var(--gold); font-family: 'Bebas Neue'; cursor: pointer; margin: 8px 0; }
        .tcard { background: var(--s2); padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 15px; border-left: 4px solid var(--gold); margin: 5px 0; }
        .tyear { font-family: 'Bebas Neue'; font-size: 28px; color: var(--gold); }
        
        .action-panel { background: var(--sur); padding: 20px; border-radius: 15px; text-align: center; margin-top: auto; }
        .btn-steal { background: var(--gold); color: black; font-family: 'Bebas Neue'; font-size: 20px; border: none; padding: 12px; border-radius: 10px; width: 100%; margin-bottom: 10px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal.open { display: flex; }
        .modal-card { background: var(--sur); padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; }
        .res-year { font-family: 'Bebas Neue'; font-size: 60px; color: var(--gold); }
    </style>
</head>
<body>

<div id="ss" class="screen active">
    <div class="logo">MUZIEKSPEL</div>
    <div class="tagline">The Timeline Game</div>

    <div id="auth-section">
        <div class="auth-card">
            <p style="margin-bottom:15px; font-size:14px; color:var(--mut);">Verbind met Spotify om de muziek te kunnen horen.</p>
            <button class="btn-spotify" onclick="loginWithSpotify()">LOG IN MET SPOTIFY</button>
        </div>
    </div>

    <div id="setup-form" class="setup-form" style="display:none">
        <div class="select-wrap">
            <select id="playlist-select">
                <option value="https://raw.githubusercontent.com/reusensm/muziekspel/main/mnm_top_2025_full.json">MNM Top 2025</option>
                <option value="https://raw.githubusercontent.com/reusensm/muziekspel/main/songsdata.json">Songs Data (Basis)</option>
            </select>
        </div>
        <div class="input-wrap"><input type="text" id="p1n" placeholder="Naam Speler 1"></div>
        <div class="input-wrap"><input type="text" id="p2n" placeholder="Naam Speler 2"></div>
        <button class="btn-start" onclick="startGame()">START SPEL</button>
    </div>
</div>

<div id="gs" class="screen">
    <div class="hdr">
        <div class="score-pill">
            <div id="hp1n" style="font-size:11px; color:var(--p1)">P1</div>
            <div class="score-num" id="hp1s">0</div>
        </div>
        <div class="score-pill" style="border-color: var(--gold)">
            <div style="font-size:11px; color:var(--mut)">BEURT</div>
            <div id="hturn" style="font-family:'Bebas Neue'; font-size:18px;">â€”</div>
        </div>
        <div class="score-pill">
            <div id="hp2n" style="font-size:11px; color:var(--p2)">P2</div>
            <div class="score-num" id="hp2s">0</div>
        </div>
    </div>

    <div class="player-wrap">
        <div class="player-mask">RAAD HET JAARTAL...</div>
        <div id="spotify-wrapper"></div>
    </div>

    <div id="active-tl" style="flex:1; overflow-y:auto;"></div>

    <div id="action-panel" class="action-panel" style="display:none"></div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-card">
        <div id="res-badge" style="font-family:'Bebas Neue'; letter-spacing:2px; color:var(--p1)">HET JAAR WAS</div>
        <div class="res-year" id="rm-year">1999</div>
        <div id="rm-song" style="font-weight:bold; margin-top:10px;">Nummer</div>
        <div id="rm-artist" style="color:var(--mut); font-size:14px; margin-bottom:20px;">Artiest</div>
        <button class="btn-start" onclick="closeModal()">VOLGENDE RONDE</button>
    </div>
</div>

<script>
const CLIENT_ID = '67388d83797b47cfb921f05009b74c9d';
const REDIRECT_URI = window.location.origin + window.location.pathname;

let ALL_SONGS = [], RAW_SONGS = [];
let SP_TOKEN = '';
let turn = 1;
let p1 = { name: "P1", score: 0, timeline: [] };
let p2 = { name: "P2", score: 0, timeline: [] };
let currentSong = null;
let pGuess = -1;
let phase = 'place';

async function init() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code) {
        SP_TOKEN = await exchangeCode(code);
        window.history.replaceState({}, "", window.location.pathname);
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('setup-form').style.display = 'block';
    }
}

function loginWithSpotify() {
    const scope = 'streaming user-read-private';
    window.location.href = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(scope)}`;
}

// Check voor token in URL (Spotify implicit grant)
const hash = window.location.hash.substring(1).split('&').reduce((acc, item) => {
    const parts = item.split('=');
    acc[parts[0]] = parts[1];
    return acc;
}, {});

if (hash.access_token) {
    SP_TOKEN = hash.access_token;
    window.history.replaceState({}, "", window.location.pathname);
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('setup-form').style.display = 'block';
}

async function startGame() {
    const url = document.getElementById('playlist-select').value;
    const res = await fetch(url);
    ALL_SONGS = await res.json();
    RAW_SONGS = [...ALL_SONGS];

    p1.name = document.getElementById('p1n').value || 'Speler 1';
    p2.name = document.getElementById('p2n').value || 'Speler 2';
    
    // Geef elke speler 1 startkaart
    p1.timeline = [RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]];
    p2.timeline = [RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]];
    
    document.getElementById('ss').classList.remove('active');
    document.getElementById('gs').classList.add('active');
    nextRound();
}

async function nextRound() {
    currentSong = RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0];
    phase = 'place';
    updateHeader();
    
    // Zoek op Spotify
    const q = encodeURIComponent(`${currentSong[1]} ${currentSong[0]}`);
    const r = await fetch(`https://api.spotify.com/v1/search?q=${q}&type=track&limit=1`, {
        headers: { 'Authorization': `Bearer ${SP_TOKEN}` }
    });
    const d = await r.json();
    const tid = d.tracks.items[0]?.id;

    if (tid) {
        document.getElementById('spotify-wrapper').innerHTML = 
            `<iframe src="https://open.spotify.com/embed/track/${tid}" width="100%" height="80" frameBorder="0" allow="autoplay; encrypted-media"></iframe>`;
    }

    renderTimeline();
    showPlaceUI();
}

function updateHeader() {
    document.getElementById('hp1n').textContent = p1.name;
    document.getElementById('hp2n').textContent = p2.name;
    document.getElementById('hp1s').textContent = p1.score;
    document.getElementById('hp2s').textContent = p2.score;
    document.getElementById('hturn').textContent = (turn === 1 ? p1.name : p2.name);
}

function renderTimeline() {
    const tl = document.getElementById('active-tl');
    const curP = turn === 1 ? p1 : p2;
    const sorted = [...curP.timeline].sort((a,b) => a[2] - b[2]);
    
    let h = `<div class="tins" onclick="handlePick(0)">VOOR ${sorted[0][2]}</div>`;
    sorted.forEach((s, i) => {
        h += `<div class="tcard"><div class="tyear">${s[2]}</div><div><strong>${s[0]}</strong><br><small>${s[1]}</small></div></div>`;
        if (i < sorted.length - 1) {
            h += `<div class="tins" onclick="handlePick(${i+1})">TUSSENIN</div>`;
        }
    });
    h += `<div class="tins" onclick="handlePick(${sorted.length})">NA ${sorted[sorted.length-1][2]}</div>`;
    tl.innerHTML = h;
}

function handlePick(pos) {
    if (phase === 'place') {
        pGuess = pos;
        showStealUI();
    } else if (phase === 'steal') {
        resolve(true, pos);
    }
}

function showPlaceUI() {
    const p = document.getElementById('action-panel');
    p.style.display = 'block';
    p.innerHTML = `<p>${(turn===1?p1.name:p2.name)}, waar hoort dit nummer?</p>`;
}

function showStealUI() {
    phase = 'steal-check';
    const opp = turn === 1 ? p2 : p1;
    const p = document.getElementById('action-panel');
    p.innerHTML = `
        <p>${opp.name}, wil je stelen?</p>
        <button class="btn-steal" onclick="startSteal()">JA, IK WEET HET BETER!</button>
        <button class="btn-start" style="background:var(--gray)" onclick="resolve(false)">NEE, PASSEN</button>
    `;
}

function startSteal() {
    phase = 'steal';
    const opp = turn === 1 ? p2 : p1;
    const sorted = [...opp.timeline].sort((a,b) => a[2] - b[2]);
    let h = `<div class="tins" onclick="resolve(true, 0)">VOOR ${sorted[0][2]}</div>`;
    sorted.forEach((s, i) => {
        h += `<div class="tcard"><div class="tyear">${s[2]}</div><div><strong>${s[0]}</strong></div></div>`;
        if (i < sorted.length - 1) h += `<div class="tins" onclick="resolve(true, ${i+1})">TUSSENIN</div>`;
    });
    h += `<div class="tins" onclick="resolve(true, ${sorted.length})">NA ${sorted[sorted.length-1][2]}</div>`;
    document.getElementById('active-tl').innerHTML = h;
    document.getElementById('action-panel').innerHTML = `<p>${opp.name}, kies de juiste plek!</p>`;
}

function resolve(stolen, stealPos) {
    const year = currentSong[2];
    const curP = turn === 1 ? p1 : p2;
    const opp = turn === 1 ? p2 : p1;

    let winner = null;

    if (stolen) {
        if (check(opp.timeline, stealPos, year)) {
            opp.score++; opp.timeline.push(currentSong);
            winner = opp;
        }
    } else {
        if (check(curP.timeline, pGuess, year)) {
            curP.score++; curP.timeline.push(currentSong);
            winner = curP;
        }
    }

    document.getElementById('rm-year').textContent = year;
    document.getElementById('rm-song').textContent = currentSong[0];
    document.getElementById('rm-artist').textContent = currentSong[1];
    document.getElementById('result-modal').classList.add('open');
}

function check(tl, pos, year) {
    const s = [...tl].sort((a,b) => a[2]-b[2]);
    if (pos === 0) return year <= s[0][2];
    if (pos === s.length) return year >= s[s.length-1][2];
    return year >= s[pos-1][2] && year <= s[pos][2];
}

function closeModal() {
    document.getElementById('result-modal').classList.remove('open');
    turn = turn === 1 ? 2 : 1;
    nextRound();
}

init();
</script>
</body>
</html>