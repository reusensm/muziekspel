<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Hitster Duo</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* ... (Keep your existing CSS from the previous response here) ... */
:root{
  --bg:#0a0a0f;--sur:#13131a;--s2:#1c1c28;
  --p1:#ff3c5c;--p2:#00d4ff;--gold:#ffd060;--green:#00cc66;
  --txt:#f0f0f0;--mut:#555;--r:16px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--txt);font-family:'DM Sans',sans-serif;min-height:100dvh;overflow-x:hidden;overscroll-behavior:none;}
.screen{display:none;min-height:100dvh;flex-direction:column;}
.screen.active{display:flex;}
#ss{align-items:center;justify-content:center;gap:22px;padding:36px 20px;background:radial-gradient(ellipse at 30% 20%,#1a0a1e,var(--bg) 60%);}
.lm{font-family:'Bebas Neue',cursive;font-size:68px;letter-spacing:6px;background:linear-gradient(135deg,var(--p1),var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;}
.ls{font-size:12px;letter-spacing:4px;color:var(--mut);text-transform:uppercase;text-align:center;}
.vinyl{width:100px;height:100px;border-radius:50%;background:conic-gradient(#222 0deg,#333 30deg,#222 60deg,#333 90deg,#222 120deg,#333 150deg,#222 180deg,#333 210deg,#222 240deg,#333 270deg,#222 300deg,#333 330deg);position:relative;animation:spin 4s linear infinite;box-shadow:0 0 36px rgba(255,60,92,.35);}
.vinyl::after{content:'';position:absolute;inset:35%;border-radius:50%;background:var(--p1);box-shadow:0 0 12px var(--p1);}
@keyframes spin{to{transform:rotate(360deg)}}
.setup{width:100%;max-width:340px;display:flex;flex-direction:column;gap:12px;}
.pi{display:flex;align-items:center;gap:12px;background:var(--sur);border-radius:var(--r);padding:12px 16px;}
.pd{width:13px;height:13px;border-radius:50%;flex-shrink:0;}
.pd.p1{background:var(--p1);box-shadow:0 0 7px var(--p1);}
.pd.p2{background:var(--p2);box-shadow:0 0 7px var(--p2);}
input[type=text]{background:none;border:none;color:var(--txt);font-family:'DM Sans',sans-serif;font-size:16px;flex:1;outline:none;}
input[type=text]::placeholder{color:var(--mut);}
.btn{display:block;width:100%;padding:14px;border:none;border-radius:var(--r);font-family:'Bebas Neue',cursive;font-size:21px;letter-spacing:3px;cursor:pointer;transition:transform .12s;text-transform:uppercase;}
.btn:active{transform:scale(.97);}
.btn-red{background:linear-gradient(135deg,var(--p1),#c0004a);color:#fff;box-shadow:0 4px 18px rgba(255,60,92,.4);}
#sg{flex-direction:column;padding:0;}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:11px 14px;background:var(--sur);border-bottom:1px solid #1a1a28;gap:8px;position:sticky;top:0;z-index:10;}
.spill{display:flex;align-items:center;gap:5px;background:var(--s2);border-radius:18px;padding:5px 11px;font-size:12px;font-weight:600;}
.sdot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.sdot.p1{background:var(--p1);}
.sdot.p2{background:var(--p2);}
.tbadge{font-family:'Bebas Neue',cursive;font-size:11px;letter-spacing:2px;color:var(--mut);text-align:center;flex:1;line-height:1.2;}
.tname{display:block;font-size:16px;color:var(--txt);}
.gbody{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:13px;}
.player-shell{background:var(--sur);border-radius:20px;overflow:hidden;position:relative;}
.player-shell::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--p1),var(--p2));z-index:4;}
.player-cover{position:relative;background:linear-gradient(135deg,#120820,#081428);padding:18px 18px 14px;display:flex;align-items:center;gap:14px;z-index:3;}
.mini-vinyl{width:44px;height:44px;border-radius:50%;background:conic-gradient(#1a1a2e 0deg,#2a2a3e 45deg,#1a1a2e 90deg,#2a2a3e 135deg,#1a1a2e 180deg,#2a2a3e 225deg,#1a1a2e 270deg,#2a2a3e 315deg);position:relative;flex-shrink:0;}
.mini-vinyl::after{content:'';position:absolute;inset:38%;border-radius:50%;background:var(--p1);}
.mini-vinyl.spin{animation:spin 2s linear infinite;box-shadow:0 0 12px rgba(255,60,92,.5);}
.player-cover-txt{flex:1;}
.player-cover-txt .pct{font-size:12px;color:var(--mut);letter-spacing:1px;}
.player-cover-txt .pcb{font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--gold);}
.sp-iframe-wrap{position:relative;height:56px;overflow:hidden;background:#121212;}
.sp-iframe-wrap iframe{position:absolute;bottom:0;left:0;width:100%;height:152px;border:none;pointer-events:auto;}
.tslot{display:flex;align-items:center;gap:9px;padding:3px 0;position:relative;}
.tslot::before{content:'';position:absolute;left:16px;top:0;bottom:0;width:2px;background:#1a1a28;z-index:0;}
.tdot{width:13px;height:13px;border-radius:50%;flex-shrink:0;z-index:1;margin-left:10px;}
.tdot.placed{background:var(--gold);box-shadow:0 0 6px var(--gold);}
.tcard{flex:1;background:var(--sur);border-radius:9px;padding:8px 11px;display:flex;justify-content:space-between;align-items:center;}
.tyear{font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;color:var(--gold);}
.tins{background:rgba(255,208,96,.06);border:2px dashed rgba(255,208,96,.22);border-radius:9px;padding:7px 11px;flex:1;color:rgba(255,208,96,.38);font-family:'Bebas Neue',cursive;font-size:12px;letter-spacing:2px;cursor:pointer;text-align:center;}
.tins.sel{background:rgba(255,208,96,.18);border-color:var(--gold);color:var(--gold);}
.spinner{width:32px;height:32px;border:3px solid #333;border-top-color:var(--p1);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto;}
</style>
</head>
<body>

<div id="ss" class="screen active">
  <div class="vinyl"></div>
  <div><div class="lm">HITSTER</div><div class="ls">Duo Edition Â· 2 spelers</div></div>
  <div id="load-status" style="font-size:12px;color:var(--mut);text-align:center">
    <div class="spinner"></div>
    <div style="margin-top:8px">Laden...</div>
  </div>
  <div class="setup" id="setup-form" style="display:none">
    <div class="pi"><div class="pd p1"></div><input type="text" id="p1n" placeholder="Speler 1 naam" maxlength="12"></div>
    <div class="pi"><div class="pd p2"></div><input type="text" id="p2n" placeholder="Speler 2 naam" maxlength="12"></div>
    <button class="btn btn-red" onclick="startGame()">Spel Starten</button>
  </div>
</div>

<div id="sp" class="screen">
  <div style="text-align:center;padding:40px;">
    <div style="font-size:68px;">ðŸ“±</div>
    <div class="lm" style="font-size:36px;">Geef de telefoon!</div>
    <p id="pass-sub" style="color:var(--mut);margin-bottom:20px;"></p>
    <button class="btn btn-red" onclick="showGame()">Ik ben klaar!</button>
  </div>
</div>

<div id="sg" class="screen">
  <div class="hdr">
    <div class="spill"><div class="sdot p1"></div><span id="hp1n">P1</span> <strong id="hp1s">0</strong></div>
    <div class="tbadge">BEURT<span class="tname" id="hturn">â€”</span></div>
    <div class="spill"><div class="sdot p2"></div><span id="hp2n">P2</span> <strong id="hp2s">0</strong></div>
  </div>
  <div class="gbody" id="gbody"></div>
</div>

<script>
let SP_TOKEN = '';
let RAW_SONGS = []; // Initially empty

// Load everything on start
async function init() {
  try {
    // 1. Fetch Spotify Token from Netlify Function
    const tokenRes = await fetch('/.netlify/functions/get-token');
    const tokenData = await tokenRes.json();
    SP_TOKEN = tokenData.access_token;

    // 2. Fetch Songs from JSON file
    const songRes = await fetch('songsdata.json');
    RAW_SONGS = await songRes.json();

    document.getElementById('load-status').style.display = 'none';
    document.getElementById('setup-form').style.display = 'flex';
  } catch (err) {
    document.getElementById('load-status').innerHTML = "Fout bij laden van data.";
    console.error(err);
  }
}

async function spSearch(q) {
  const r = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=1&market=BE`, {
    headers: { 'Authorization': 'Bearer ' + SP_TOKEN }
  });
  return r.json();
}

let p1 = { name: "", score: 0, timeline: [] };
let p2 = { name: "", score: 0, timeline: [] };
let turn = 1; 
let currentSong = null;

async function startGame() {
  p1.name = document.getElementById('p1n').value || "Speler 1";
  p2.name = document.getElementById('p2n').value || "Speler 2";
  
  // Starting cards
  p1.timeline.push(RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]);
  p2.timeline.push(RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0]);
  
  updateHeader();
  nextRound();
}

function updateHeader() {
  document.getElementById('hp1n').innerText = p1.name;
  document.getElementById('hp2n').innerText = p2.name;
  document.getElementById('hp1s').innerText = p1.score;
  document.getElementById('hp2s').innerText = p2.score;
  document.getElementById('hturn').innerText = turn === 1 ? p1.name : p2.name;
}

async function nextRound() {
  if (RAW_SONGS.length === 0) { alert("Geen nummers meer!"); return; }
  
  currentSong = RAW_SONGS.splice(Math.floor(Math.random()*RAW_SONGS.length), 1)[0];
  const searchData = await spSearch(`${currentSong[0]} ${currentSong[1]}`);
  const trackId = searchData.tracks.items[0].id;

  showScreen('sp');
  document.getElementById('pass-sub').innerText = `Het is de beurt aan ${turn === 1 ? p1.name : p2.name}`;
  renderGame(trackId);
}

function renderGame(trackId) {
  const body = document.getElementById('gbody');
  body.innerHTML = `
    <div class="player-shell">
      <div class="player-cover">
        <div class="mini-vinyl spin"></div>
        <div class="player-cover-txt">
          <div class="pct">LUISTER NU</div>
          <div class="pcb">Plaats op de tijdlijn</div>
        </div>
      </div>
      <div class="sp-iframe-wrap">
        <iframe src="https://open.spotify.com/embed/track/${trackId}" allow="encrypted-media"></iframe>
      </div>
    </div>
    <div class="timeline" id="active-tl"></div>
  `;
  renderTimeline();
}

function renderTimeline() {
  const tl = document.getElementById('active-tl');
  const player = turn === 1 ? p1 : p2;
  const sorted = [...player.timeline].sort((a,b) => a[2] - b[2]);
  
  let html = `<div class="tins" onclick="checkAnswer(-1)">VOOR ${sorted[0][2]}</div>`;
  sorted.forEach((song, i) => {
    html += `
      <div class="tslot">
        <div class="tdot placed"></div>
        <div class="tcard"><span class="tyear">${song[2]}</span><span class="tinfo">${song[0]}</span></div>
      </div>
    `;
    if(i < sorted.length - 1) {
      html += `<div class="tins" onclick="checkAnswer(${i})">TUSSEN ${sorted[i][2]} & ${sorted[i+1][2]}</div>`;
    }
  });
  html += `<div class="tins" onclick="checkAnswer(${sorted.length-1})">NA ${sorted[sorted.length-1][2]}</div>`;
  tl.innerHTML = html;
}

function checkAnswer(index) {
  const player = turn === 1 ? p1 : p2;
  const sorted = [...player.timeline].sort((a,b) => a[2] - b[2]);
  const year = currentSong[2];
  
  let correct = false;
  if(index === -1 && year <= sorted[0][2]) correct = true;
  else if(index === sorted.length-1 && year >= sorted[sorted.length-1][2]) correct = true;
  else if(index >= 0 && index < sorted.length-1 && year >= sorted[index][2] && year <= sorted[index+1][2]) correct = true;

  if(correct) {
    alert(`Lekker! Het was idd ${currentSong[0]} (${currentSong[2]})`);
    player.score++;
    player.timeline.push(currentSong);
  } else {
    alert(`Fout! Dit was ${currentSong[0]} uit ${currentSong[2]}`);
  }

  turn = turn === 1 ? 2 : 1;
  updateHeader();
  nextRound();
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showGame() { showScreen('sg'); }

// Kickstart
init();
</script>
</body>
</html>